Partial backport of https://github.com/olivere/elastic
